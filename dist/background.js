(()=>{"use strict";var e={136:function(e,r,t){var n=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function c(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(a,c)}s((n=n.apply(e,r||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.getBearerToken=void 0;const o=t(593),i=e=>{chrome.runtime.sendMessage({action:"log",value:e},(()=>{}))};function a(){return chrome.storage.local.get(["ffiii_bearer"]).then((e=>e.value))}r.getBearerToken=a;const c=(e,r)=>n(void 0,void 0,void 0,(function*(){return i(`token request body for public client: ${r}`),yield fetch(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:r.toString()}).then((e=>e.json())).then((e=>e))}));chrome.runtime.onMessage.addListener(((e,r,t)=>{return i(`[message] ${JSON.stringify(e)}`),"submit"===e.action&&(s=e.value,n(void 0,void 0,void 0,(function*(){i(`params: ${JSON.stringify(s)}`);const e=(0,o.generateCodeVerifier)();i(`generate code_verifier: ${e}`);const r=yield((e,r)=>n(void 0,void 0,void 0,(function*(){const t=new URL(e.authorizationEndpoint);t.searchParams.set("client_id",e.clientId),t.searchParams.set("redirect_uri",e.redirectUri),t.searchParams.set("response_type","code"),t.searchParams.set("code_challenge_method","S256");const n=yield(0,o.generateCodeChallenge)(r);return t.searchParams.set("code_challenge",n),t.toString()})))(s,e);i(`build authorizationUrl: ${r}`),chrome.identity.launchWebAuthFlow({url:r,interactive:!0},(r=>n(void 0,void 0,void 0,(function*(){if(void 0===r)return void i("[error] callbackUrlString is undefined");i(`callbacked url: ${r}`);const t=new URL(r).searchParams.get("code");if(null===t)return void i("[error] code is null");i(`code: ${t}`);const n=(0,o.createURLSearchParams)({grant_type:"authorization_code",client_id:s.clientId,redirect_uri:s.redirectUri,code:t,code_verifier:e}),a=yield c(s.tokenEndpoint,n);try{JSON.stringify(a)}catch(e){i(`[error] got malformed json response: ${a}, error: ${e}`)}return chrome.runtime.sendMessage({action:"result",value:JSON.stringify(a)},(()=>{})),chrome.storage.local.set({ffiii_bearer:a.access_token})}))))}))).catch((e=>{i(`[error] ${e}`)})),"store_transactions"===e.action&&(console.log("storing"),a().then((e=>{console.log(`store transactions using token ${e}`)}))),!0;var s}))},593:function(e,r){var t=this&&this.__awaiter||function(e,r,t,n){return new(t||(t=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function c(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var r;e.done?o(e.value):(r=e.value,r instanceof t?r:new t((function(e){e(r)}))).then(a,c)}s((n=n.apply(e,r||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.createURLSearchParams=r.generateCodeChallenge=r.generateCodeVerifier=void 0,r.generateCodeVerifier=(e=43)=>{const r="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~";return Array.from(crypto.getRandomValues(new Uint32Array(e))).map((e=>r[e%r.length])).join("")},r.generateCodeChallenge=e=>t(void 0,void 0,void 0,(function*(){var r=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));return btoa(String.fromCharCode(...new Uint8Array(r))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")})),r.createURLSearchParams=e=>{const r=new URLSearchParams;return Object.keys(e).forEach((t=>r.append(t,e[t]))),r}}},r={};!function t(n){var o=r[n];if(void 0!==o)return o.exports;var i=r[n]={exports:{}};return e[n].call(i.exports,i,i.exports,t),i.exports}(136)})();