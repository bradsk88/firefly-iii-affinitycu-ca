(()=>{"use strict";var e={136:function(e,t,r){var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function c(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,c)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0});const o=r(593),i=e=>{chrome.runtime.sendMessage({action:"log",value:e},(()=>{}))},a=(e,t,r,o,a)=>n(void 0,void 0,void 0,(function*(){const n={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"};if("client_secret_basic"===a){const e="Basic "+btoa(`${t}:${r}`);i(`using Authorization header: ${e}`),n.Authorization=e}else"client_secret_post"===a?(i("set authorization params in body"),o.append("client_secret",r)):i(`[error] unknown token request auth: ${a}`);return i(`token request body for confidential client: ${o}`),yield fetch(e,{method:"POST",headers:n,body:o.toString()}).then((e=>e.json())).then((e=>e))}));chrome.runtime.onMessage.addListener(((e,t,r)=>{return"submit"===e.action&&(c=e.value,n(void 0,void 0,void 0,(function*(){i(`params: ${JSON.stringify(c)}`);const e=(0,o.generateCodeVerifier)();i(`generate code_verifier: ${e}`);const t=yield((e,t)=>n(void 0,void 0,void 0,(function*(){const r=new URL(e.authorizationEndpoint);r.searchParams.set("client_id",e.clientId),r.searchParams.set("redirect_uri",e.redirectUri),r.searchParams.set("response_type","code"),r.searchParams.set("code_challenge_method","SHA-256");const n=yield(0,o.generateCodeChallenge)(t);return r.searchParams.set("code_challenge",n),r.toString()})))(c,e);i(`build authorizationUrl: ${t}`),chrome.identity.launchWebAuthFlow({url:t,interactive:!0},(e=>n(void 0,void 0,void 0,(function*(){if(void 0===e)return void i("[error] callbackUrlString is undefined");i(`callbacked url: ${e}`);const t=new URL(e).searchParams.get("code");if(null===t)return void i("[error] code is null");i(`code: ${t}`);const r=(0,o.createURLSearchParams)({grant_type:"authorization_code",client_id:c.clientId,redirect_uri:c.redirectUri,code:t}),n=yield a(c.tokenEndpoint,c.clientId,c.clientSecret,r,c.tokenEndpointAuthMethod);try{JSON.stringify(n)}catch(e){i(`[error] got malformed json response: ${n}, error: ${e}`)}chrome.runtime.sendMessage({action:"result",value:JSON.stringify(n)},(()=>{}))}))))}))).catch((e=>{i(`[error] ${e}`)})),!0;var c}))},593:function(e,t){var r=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{s(n.next(e))}catch(e){i(e)}}function c(e){try{s(n.throw(e))}catch(e){i(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,c)}s((n=n.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.createURLSearchParams=t.generateCodeChallenge=t.generateCodeVerifier=void 0,t.generateCodeVerifier=(e=43)=>{const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~";return Array.from(crypto.getRandomValues(new Uint32Array(e))).map((e=>t[e%t.length])).join("")},t.generateCodeChallenge=e=>r(void 0,void 0,void 0,(function*(){var t=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e));return btoa(String.fromCharCode(...new Uint8Array(t))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")})),t.createURLSearchParams=e=>{const t=new URLSearchParams;return Object.keys(e).forEach((r=>t.append(r,e[r]))),t}}},t={};!function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n].call(i.exports,i,i.exports,r),i.exports}(136)})();